# 아동복 도매 수집 시스템 — 서비스 설계문서

> **문서 버전**: 2.0  
> **작성일**: 2026-02-17  
> **대상 독자**: 구현 담당 모델 / 개발자  
> **목적**: 구현 모델이 세부 구현으로 바로 내려갈 수 있는 상위 구조 설계

---

## 1. 시스템 개요

### 1.1 목적

CSV에 정의된 아동복 상품 목록을 기반으로, 도매 사이트에서 상품 정보와 이미지를 수집하고, 판매용 메시지 파일을 생성하는 자동화 시스템.

카카오톡 전송은 **수동** 으로 수행한다 (추후 자동화 확장 예정).

### 1.2 MVP 범위

| 포함 | 미포함 (추후) |
|------|---------------|
| 도매 사이트 로그인·상품 수집 | 카카오톡 자동 전송 |
| 이미지 다운로드 및 상품별 정리 | 전송 상태 추적 |
| 메시지 생성 및 파일 출력 | 스케줄러 |
| 상품별 자체 완결 폴더 출력 | 다중 도매 사이트 |

### 1.3 아키텍처 다이어그램

```
┌──────────────┐
│   CSV Input   │
└──────┬───────┘
       │
       ▼
┌─────────────────────┐
│ Product Orchestrator │
└────┬────────────┬───┘
     │            │
     ▼            ▼
┌──────────┐  ┌──────────────┐
│ Scraper  │  │ Image Manager │
└────┬─────┘  └──────┬───────┘
     │               │
     └───────┬───────┘
             ▼
      ┌──────────────┐
      │ Message Builder │
      └──────┬───────┘
             │
             ▼
      ┌──────────────┐
      │  File Output  │
      │ (per product) │
      └──────────────┘
```

---

## 2. 출력 구조

시스템의 최종 출력물은 **상품 폴더 자체 완결형**이다. 각 상품 폴더에 이미지와 메시지가 함께 들어있어, 폴더 하나를 열면 수동 전송에 필요한 모든 것이 갖춰진다.

### 2.1 디렉토리 레이아웃

```
output/
├── ABC123/
│   ├── 01.jpg
│   ├── 02.jpg
│   └── message.txt          # 이 상품의 전송용 메시지
├── DEF456/
│   ├── 01.jpg
│   └── message.txt
└── summary.txt               # 전체 수집 결과 요약
```

### 2.2 상품별 `message.txt`

각 상품 폴더 안에 해당 상품의 전송용 메시지를 저장한다. 카카오톡 전송 시 이 파일의 내용을 그대로 복사·붙여넣기하면 된다.

### 2.3 `summary.txt`

전체 실행 결과를 한눈에 파악할 수 있는 요약 파일. 성공/실패 현황과 상품 목록을 포함한다.

### 2.4 수동 전송 워크플로우

1. `output/` 내 상품 폴더를 연다
2. 이미지 파일을 선택하여 카카오톡 채팅방에 드래그
3. `message.txt`를 열어 내용 복사 → 채팅방에 붙여넣기
4. 전송 완료된 폴더는 삭제 또는 이동하여 진행 추적

---

## 3. 데이터 모델

### 3.1 입력: CSV

| 컬럼명 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `url` | string | Y | 도매 상품 상세 페이지 URL (Scraper가 직접 접근) |
| `margin` | integer | Y | 마진 금액 (도매가 + margin = 판매가로 자동 계산) |

상품 식별자(폴더명)는 URL에서 추출하거나 구현 모델이 적절히 생성한다.

### 3.2 내부 모델

구현 모델이 적절한 형태(dataclass, Pydantic 등)로 정의한다. 최소 필드:

**ScrapedProduct**:
- `product_id`, `product_name`, `wholesale_price`, `sizes[]`, `colors[]`
- `wholesale_price`는 도매 사이트에서 스크래핑한 원가 (참고/로깅용, 메시지에 노출하지 않음)
- 이미지는 별도 URL 목록이 아닌, 상세 페이지의 다운로드 버튼을 통해 획득

**ProcessedProduct** (ScrapedProduct + CSV 입력 + 로컬 처리 결과):
- 위 필드 + `selling_price` (도매가 + margin으로 산출), `local_image_paths[]`, `message`
- `selling_price`가 메시지에 표시되는 최종 가격

---

## 4. 컴포넌트 설계

### 4.1 Product Orchestrator

전체 파이프라인 제어기.

- CSV 로드
- 도매 로그인
- 상품별 순차 처리: 수집 → 이미지 저장 → 메시지 생성 → 상품 폴더에 기록
- 전체 완료 후 summary.txt 출력
- 실패 상품은 로그에 기록하고 다음 상품으로 진행

### 4.2 Wholesale Scraper

도매 사이트 로그인 및 상품 상세 정보 수집.

- CSV의 URL을 직접 받아 상품 페이지에 접근
- 상품명, 도매가, 사이즈, 컬러 등 텍스트 정보 추출
- **이미지는 상세 페이지의 다운로드 버튼을 통해 획득** (URL 직접 추출이 아님)
- 위 특성상 브라우저 자동화(Selenium 등)가 필요할 수 있음
- 셀렉터는 설정 파일에서 관리 (사이트 구조 변경 대응)

### 4.3 Image Manager

Scraper가 다운로드한 이미지 파일의 정리 및 로컬 저장.

- 다운로드된 파일을 상품 폴더(`output/{product_id}/`)로 이동·정리
- 순번 기반 파일명 (`01.jpg`, `02.jpg`, ...)
- 이미 존재하면 스킵 (멱등성)

### 4.4 Message Builder

상품 데이터로부터 텍스트 메시지 생성.

- 템플릿 기반 (`templates/message_template.txt`)
- **가격은 도매가 + CSV의 margin으로 산출된 판매가를 사용**
- 빈 필드는 해당 줄 제거
- 가격은 천 단위 콤마 적용
- 리스트 필드(사이즈, 컬러)는 `/`로 조인

---

## 5. 설정

### 5.1 구조

```yaml
# config/settings.yaml
paths:
  input_csv: "data/input/products.csv"
  output_dir: "output"
  message_template: "templates/message_template.txt"

wholesale:
  base_url: ""
  login_url: ""
  selectors:
    product_name: ""
    price: ""
    sizes: ""
    colors: ""
    images: ""
  request_delay_seconds: 1.0
```

```yaml
# config/credentials.yaml (.gitignore 대상)
wholesale:
  username: ""
  password: ""
```

### 5.2 규약

- 환경변수로 오버라이드 가능 (`PM_WHOLESALE_USERNAME` 등)
- 구현 모델이 적절한 로드 방식을 결정

---

## 6. 실행 흐름

```
1. 설정 로드 + CSV 로드
2. 도매 로그인
3. For each CSV row (url, margin):
   a. URL로 상품 상세 수집 (Scraper)
   b. 판매가 산출 (도매가 + margin)
   c. 이미지 다운로드 → 상품 폴더에 저장 (Image Manager)
   d. 메시지 생성 (산출된 판매가 사용) → 상품 폴더에 message.txt 기록 (Message Builder)
   e. 실패 시 → 로그 기록, 다음 상품으로 진행
4. summary.txt 출력 (성공/실패 수, 상품 목록)
```

---

## 7. 에러 처리

| 등급 | 예시 | 대응 |
|------|------|------|
| 치명적 | 로그인 실패 | 즉시 중단 |
| 상품 수준 | 페이지 404, 파싱 실패 | 해당 상품 스킵, 로그 기록 |
| 일시적 | 네트워크 타임아웃 | 재시도 (횟수·간격은 구현 모델 판단) |

실패한 상품 목록은 별도 파일로 출력하여 재실행 시 활용할 수 있도록 한다.

---

## 8. 기술 스택

| 항목 | 선택 |
|------|------|
| 언어 | Python 3.11+ |
| HTTP | `requests` |
| HTML 파싱 | `beautifulsoup4` |
| 브라우저 자동화 | `selenium` (이미지 다운로드 버튼 클릭 등) |
| 설정 | YAML (`pyyaml`) |

그 외 패키지 선택은 구현 모델에 위임한다.

---

## 9. 제약 및 위험

| 항목 | 설명 |
|------|------|
| 도매 사이트 HTML 변경 | 셀렉터를 설정 파일로 외부화하여 대응 |
| IP 차단 리스크 | 요청 간격 설정으로 완화 |
| 인코딩 | 도매 사이트 인코딩에 맞는 처리 필요 |

---

## 10. 확장 지점 (추후)

| 영역 | 설명 |
|------|------|
| **카카오톡 자동 전송** | 카카오톡 PC 데스크탑 앱 + GUI 자동화로 이미지·메시지 자동 전송 |
| 다중 메신저 | Adapter 패턴으로 카카오/라인/텔레그램 등 확장 |
| 다중 도매 사이트 | Scraper를 Strategy 패턴으로 확장 |
| 전송 상태 추적 | 상품별 상태 관리 (수집→전송 완료) |
| 스케줄러 | 정기 실행 |

---

*문서 끝*
